# Сервис запросов по кадастровым номерам "

## Задача ##
Разработать сервис для обработки запросов на недвижимость и отправки запросов на сторонний сервер для проверки данных. Сервис должен хранить данные запросов, результаты проверки и историю всех запросов в базе данных. Он должен включать основной API, панель администратора, систему кэширования, функциональные тесты, документацию и быть развернут с использованием Docker Compose.

## Обзор проекта
Этот проект состоит из:
- API основного и стороннего сервисов (DRF) для управления кадастровыми запросами и валидации наличия объектов недвижимости из запросов в базе данных.
- Админ панель основного сервиса 
- Celery для асинхронной отправки запроса от основного сервера к стороннему
- Redis в качестве брокера сообщений,
- Docker Compose для оркестрации контейнеров,
- Интегрированные тесты
- Swagger/OpenAPI для документации API.

### 1. Интеграция и связь двух сервисов
Проект включает два ключевых сервиса:

- Сервис Query_API: обрабатывает основную функциональность приложения, включая:
  -  создание кадастровых запросов;
  -  отправка этих запросов в API стороннего сервиса;
  -  получение и сохранение результатов в базе;
  -  хранение в базе истории всех запросов с возможностью поиска запроса по кадастровому номеру;
  - админ интерфейс для управления данными запросов.
    
- Сторонний сервис: отдельный сервис ( в моем проекте его работа симулирована на порту 8001), который принимает запросы от основного сервиса, проверяет наличие объекта в базе данных и возвращает результат проверки 

Интеграция:

Основной сервис Query_API взаимодействует со сторонним сервисом через HTTP-запросы. Отправка GET-запроса на эндпойнт /api/result/ стороннего сервиса для проверки существования объекта недвижимости по кадастровому номеру реализована асинхронно с помощью библиотеки requests и Celery.

Сторонний сервис отвечает данными в формате JSON, которые передаются в задачу Celery для добавления значения результата проверки в запись о запросе в базе данных основного сервиса.

### 2. Задачи Celery
Celery используется для обработки асинхронных задач, таких как отправка запросов на сторонний сервис и обновление базы данных результатами.

### 3. Docker Compose
Docker Compose используется для оркестрации нескольких Docker-контейнеров для проекта.

Конфигурация: Определена в файле compose.yml, который включает сервисы для:
- MyService: Запускает приложение Query_API на Django.
- Third-party-server: Запускает приложение Third_party_server на Django.
- Redis: Предоставляет брокера сообщений для Celery.
- Celery: Обрабатывает фоновые задачи.

## Установка
Необходимые условия:

- Python 3.8+

- Django 4.0+

- Celery

- Redis

## Настройка
Клонируйте репозиторий:
```
git clone https://github.com/Baobear520/Cadastral-Query-Service.git
```

### Сначала нужно настроить сервис Query_API, который находится в папке Project.
```
cd Project
```

Создайте и активируйте виртуальное окружение:
```
python -m venv venv
source venv/bin/activate # На Mac/Linux
venv\Scripts\activate # На Windows
```

Установите зависимости:
```
pip install -r requirements.txt
```

Создайте миграции для базы данных:
```
python manage.py makemigrations
```
Примените миграции:
```
python manage.py migrate
```

Создайте суперпользователя:
```
python manage.py createsuperuser
```


### Далее нужно настроить сервис Third_party_server, который отвечает за:
- хранение актуальных данных о недвижимости;

- приём GET-запросов на свой endpoint api/result/ от Celery и возврат ответа.

Повторите все шаги, как для Query_API.

## Запуск проекта
### В терминале

Запустите сервер Query_API на порту 8000:
```
python manage.py runserver 8000
```

Сервер будет доступен по адресу http://localhost:8000.

Запустите Redis:
Я запустил его в контейнере Docker, привязанном к http://localhost:6379/0 на моей машине.

Запустите Celery worker:
В отдельном терминале запустите worker Celery:
```
celery -A config worker --loglevel=info
```

Запустите сервер Third_party_server на порту 8001:
```
python manage.py runserver 8001
```

Сервер будет доступен по адресу http://localhost:8001.

### В контейнере Docker

Чтобы запустить Сервис кадастровых запросов в Docker, выполните следующие шаги:

#### Необходимые условия

- **Docker**: Убедитесь, что Docker установлен и запущен на вашем компьютере. Вы можете скачать его с [официального сайта Docker](https://www.docker.com/products/docker-desktop).
- **Docker Compose**: Установите Docker Compose для управления многоконтейнерными Docker-приложениями. Обычно он поставляется с Docker Desktop, но вы также можете установить его отдельно с [официального сайта Docker Compose](https://docs.docker.com/compose/install/).

Создайте контейнер с docker-compose и запустите его:
```
docker compose up --build
```
или запустите контейнер docker-compose в клиенте Docker.

## Использование
### Сервис Query_API
API Endpoints
- Создание запроса

POST /api/query/

Тело запроса: { "cadastral_number": "string", "latitude": float, "longitude": float }

Ответ: { "query_id": "string" }

- Получение истории всех запросов/запроса, отфильтрованного по кадастровому номеру.

GET /api/history/

Ответ: Список исторических запросов с пагинацией/запрос, отфильтрованный по значению cadastral_number

Параметры запроса: cadastral_number

Ответ: { "cadastral_number": "string", "latitude": float, "longitude": float, "result": "boolean", "created_at": datetime, "updated_at": datetime }

### Сервис Third_party_server
API Endpoints
- Проверка, существует ли объект недвижимости с данным кадастровым номером

GET /api/result/

Параметры запроса: cadastral_number

Ответ: { "result": "boolean" }

## Тестирование
Запустите тесты с использованием тестового раннера Django:
```
python manage.py test
```

Чтобы запустить конкретные тесты, используйте:
```
python manage.py test query_api.tests.test_api python manage.py test property_api.tests.test_api
```


## Контакты
По любым вопросам или для получения поддержки пишите на admitry424@gmail.com
